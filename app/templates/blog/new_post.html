{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <!-- Post Title and Meta -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h2 class="card-title text-primary">{{ post.title }}</h2>
      <p class="text-muted mb-2">By {{ post.user.username }} | {{ post.created_at.strftime("%b %d, %Y") }} | {{ post.views or 0 }} views</p>
      <p class="card-text">{{ post.content | safe }}</p>

      {% if post.media_filename %}
      <div class="my-3">
        <img src="{{ url_for('static', filename='uploads/media/' + post.media_filename) }}" class="img-fluid rounded">
      </div>
      {% endif %}

      <!-- Like Button for Post -->
      <form action="{{ url_for('blog.like_post', post_id=post.id) }}" method="POST" class="d-inline">
        <button type="submit" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-hand-thumbs-up-fill"></i> Like ({{ post.likes or 0 }})
        </button>
      </form>
    </div>
  </div>

  <!-- Comment Section -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <strong>Comments ({{ post.comments|length }})</strong>
    </div>
    <div class="card-body">

      <!-- Add Comment Form -->
      {% if current_user.is_authenticated %}
      <form action="{{ url_for('blog.view_post', slug=post.slug) }}" method="POST" class="mb-4">
        <div class="mb-3">
          <textarea name="content" class="form-control" rows="3" placeholder="Add a comment..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
      </form>
      {% else %}
      <p class="text-muted">You must <a href="{{ url_for('auth.login') }}">log in</a> to comment.</p>
      {% endif %}

      <!-- Display Comments -->
      {% for comment in comments %}
      <div class="border rounded p-3 mb-3">
        <div class="d-flex justify-content-between">
          <strong>{{ comment.user.username }}</strong>
          <small class="text-muted">{{ comment.created_at.strftime("%b %d, %Y %H:%M") }}</small>
        </div>
        <p class="mt-2 mb-1">{{ comment.content }}</p>

        <!-- Comment Buttons: Like, Reply, Edit -->
        <div class="d-flex align-items-center mt-2">
          <!-- Like Comment -->
          <form action="{{ url_for('blog.like_comment', comment_id=comment.id) }}" method="POST" class="me-2">
            <button type="submit" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-hand-thumbs-up-fill text-primary"></i> ({{ comment.likes or 0 }})
            </button>
          </form>

          <!-- Reply Button -->
          {% if current_user.is_authenticated %}
          <button class="btn btn-sm btn-outline-secondary me-2" type="button"
            data-bs-toggle="collapse" data-bs-target="#replyForm{{ comment.id }}">Reply</button>

          {% if comment.user_id == current_user.id %}
          <!-- Edit Button -->
          <button class="btn btn-sm btn-outline-warning" type="button"
            data-bs-toggle="collapse" data-bs-target="#editComment{{ comment.id }}">Edit</button>
          {% endif %}
          {% endif %}
        </div>

        <!-- Edit Comment Form -->
        <div class="collapse mt-2" id="editComment{{ comment.id }}">
          <form action="{{ url_for('blog.edit_comment', comment_id=comment.id) }}" method="POST">
            <div class="mb-2">
              <textarea name="content" class="form-control" rows="2">{{ comment.content }}</textarea>
            </div>
            <button type="submit" class="btn btn-warning btn-sm">Update</button>
          </form>
        </div>

        <!-- Reply Form -->
        <div class="collapse mt-2" id="replyForm{{ comment.id }}">
          <form action="{{ url_for('blog.add_reply', comment_id=comment.id) }}" method="POST">
            <div class="mb-2">
              <textarea name="reply_content" class="form-control" rows="2" placeholder="Write a reply..." required></textarea>
            </div>
            <button type="submit" class="btn btn-secondary btn-sm">Reply</button>
          </form>
        </div>

        <!-- Replies Section -->
        {% if comment.replies %}
        <div class="mt-3 ms-4 border-start ps-3">
          {% for reply in comment.replies %}
          <div class="mb-2">
            <strong>{{ reply.user.username }}</strong>
            <small class="text-muted">{{ reply.created_at.strftime("%b %d, %Y %H:%M") }}</small>
            <p class="mb-1">{{ reply.content }}</p>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% else %}
      <p class="text-muted">No comments yet. Be the first to comment!</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %}
